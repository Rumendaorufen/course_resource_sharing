# 作业功能修复报告

## 修复概述

本报告总结了对课程资源共享平台中作业管理功能的全面修复工作，包括作业提交统计数据准确性修复、作业文件上传功能优化、作业详情查看功能改进以及评分系统完善等多个方面的修改。这些修复确保了教师和学生能够更好地使用作业管理相关功能。

## 问题描述

在修复前，系统存在以下问题：

### 1. 统计数据准确性问题
- **总人数统计错误**：总人数(`totalStudents`)仅统计了有提交记录的学生，而非课程中所有的学生
- **未提交人数计算错误**：未提交人数(`notSubmittedCount`)仅基于有提交记录但状态不是SUBMITTED的学生计算，导致统计结果不完整
- **教师无法准确了解整体提交情况**：由于统计逻辑错误，教师无法正确掌握班级学生的作业完成率

### 2. 作业文件上传问题
- **文件上传流程不完善**：学生在提交作业时，文件上传功能存在缺陷
- **文件下载功能异常**：教师无法正常下载学生提交的作业附件

### 3. 作业详情查看问题
- **作业内容展示不完整**：教师查看学生提交内容时信息显示不全
- **附件关联显示问题**：作业附件与提交内容的关联展示存在问题

### 4. 评分系统问题
- **评分流程不顺畅**：教师进行作业评分时操作繁琐
- **评语输入功能不完善**：无法有效添加评语或评语保存失败

## 修复内容

### 1. 前端代码修改

修改文件：`frontend/src/views/AssignmentSubmissions.vue`, `frontend/src/views/HomeworkSubmission.vue`

#### 1.1 统计数据准确性修复

#### 1.1 引入课程学生API

```javascript
import { getStudentsInCourse } from '@/api/course'
```

#### 1.2 新增课程学生列表变量

```javascript
const allCourseStudents = ref([])
```

#### 1.3 修改统计数据计算逻辑

- **总人数计算**：从使用提交记录数量改为使用课程所有学生数量
  ```javascript
  // 修改前
  const totalStudents = computed(() => submissions.value.length)
  // 修改后
  const totalStudents = computed(() => allCourseStudents.value.length)
  ```

- **未提交人数计算**：从提交记录中筛选改为基于课程总人数减去已提交人数
  ```javascript
  // 修改前
  const notSubmittedCount = computed(() => submissions.value.filter(s => !s.status || s.status !== 'SUBMITTED').length)
  // 修改后
  const notSubmittedCount = computed(() => {
    if (allCourseStudents.value.length === 0) return 0
    return allCourseStudents.value.length - submittedCount.value
  })
  ```

#### 1.4 新增加载课程学生列表函数

```javascript
// 加载课程学生列表
const loadCourseStudents = async (courseId) => {
  try {
    const response = await getStudentsInCourse(courseId)
    if (response.data.code === 200) {
      allCourseStudents.value = Array.isArray(response.data.data) ? response.data.data : []
    }
  } catch (error) {
    console.error('获取课程学生列表失败:', error)
  }
}
```

#### 1.5 修改作业信息加载函数

在加载作业信息后，自动获取对应课程的学生列表：

```javascript
// 加载作业信息
const loadAssignment = async () => {
  try {
    loading.value = true
    const { data } = await request.get(`/assignments/${route.params.id}`)
    if (data.code === 200) {
      assignment.value = data.data
      // 获取课程学生列表
      if (assignment.value.courseId) {
        await loadCourseStudents(assignment.value.courseId)
      }
    } else {
      ElMessage.error(data.message || '获取作业信息失败')
    }
  } catch (error) {
    console.error('获取作业信息失败:', error)
    ElMessage.error('获取作业信息失败')
  } finally {
    loading.value = false
  }
}
```

## 修复效果

1. **统计数据准确性提升**：
   - 总人数现在正确显示课程中的所有学生数量
   - 未提交人数准确计算为课程总人数减去已提交人数
   - 逾期提交人数计算逻辑保持不变，仍基于提交记录

2. **教师使用体验改善**：
   - 教师可以准确了解班级整体作业完成情况
   - 能够清晰识别哪些学生尚未提交作业
   - 统计面板数据与实际情况一致

3. **数据一致性**：
   - 统计数据与课程学生列表保持同步
   - 确保了即使没有提交记录的学生也被纳入统计范围

#### 1.2 作业文件上传与下载功能优化

**文件下载功能改进**：
```javascript
// 下载附件
const downloadFile = async (submission) => {
      if (!submission.attachmentUrl) return
      
      try {
        // 使用fetch API下载文件
        const response = await fetch(submission.attachmentUrl);
        if (!response.ok) {
          throw new Error('网络响应错误');
        }
        
        // 获取文件名
        let filename = submission.attachmentName;
        if (!filename) {
          // 从URL或响应头中提取文件名
          const contentDisposition = response.headers.get('content-disposition');
          if (contentDisposition) {
            const match = contentDisposition.match(/filename="(.+)"/);
            if (match && match[1]) {
              filename = match[1];
            }
          }
          if (!filename) {
            // 使用URL中的文件名作为默认值
            filename = submission.attachmentUrl.split('/').pop();
          }
        }
        
        // 将响应转换为Blob
        const blob = await response.blob();
        
        // 创建下载链接并触发点击
        const link = document.createElement('a');
        const url = window.URL.createObjectURL(blob);
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        
        // 清理
        window.URL.revokeObjectURL(url);
        document.body.removeChild(link);
      } catch (error) {
        console.error('下载文件失败:', error);
        ElMessage.error('文件下载失败，请稍后重试');
      }
    }
```

#### 1.3 作业详情查看功能改进

**作业详情对话框优化**：
- 完善了作业详情展示，包括提交时间、作业内容、附件、分数和评语等信息
- 改进了附件下载链接的显示和交互

```html
<!-- 查看提交内容对话框 -->
<el-dialog
  v-model="dialogVisible"
  :title="`${currentSubmission?.studentName || ''} 的提交内容`"
  width="50%"
>
  <el-descriptions :column="1" border>
    <el-descriptions-item label="提交时间">
      {{ currentSubmission?.submitTime || '-' }}
    </el-descriptions-item>
    <el-descriptions-item label="作业内容">
      {{ currentSubmission?.content }}
    </el-descriptions-item>
    <el-descriptions-item v-if="currentSubmission?.attachmentUrl" label="附件">
      <el-button type="primary" link @click="downloadFile(currentSubmission)">
        下载附件
      </el-button>
    </el-descriptions-item>
    <el-descriptions-item v-if="currentSubmission?.score" label="分数">
      {{ currentSubmission?.score }}
    </el-descriptions-item>
    <el-descriptions-item v-if="currentSubmission?.comment" label="评语">
      {{ currentSubmission?.comment }}
    </el-descriptions-item>
  </el-descriptions>
</el-dialog>
```

#### 1.4 评分系统完善

**评分对话框优化**：
- 改进了评分界面的用户体验
- 完善了分数输入和评语功能

```html
<!-- 打分对话框 -->
<el-dialog
  v-model="gradeDialogVisible"
  :title="`为 ${currentSubmission?.studentName || ''} 打分`"
  width="30%"
>
  <el-form :model="gradeForm" label-width="80px">
    <el-form-item label="分数">
      <el-input-number v-model="gradeForm.score" :min="0" :max="100" />
    </el-form-item>
    <el-form-item label="评语">
      <el-input
        v-model="gradeForm.comment"
        type="textarea"
        :rows="3"
        placeholder="请输入评语"
      />
    </el-form-item>
  </el-form>
  <template #footer>
    <span class="dialog-footer">
      <el-button @click="gradeDialogVisible = false">取消</el-button>
      <el-button type="primary" @click="submitGrade">
        确定
      </el-button>
    </span>
  </template>
</el-dialog>
```

**评分提交功能改进**：
```javascript
// 提交打分
const submitGrade = async () => {
  try {
    const { data } = await request.put(`/api/homework-submissions/${currentSubmission.value.id}/grade`, null, {
      params: {
        score: gradeForm.value.score,
        comment: gradeForm.value.comment
      }
    })
    if (data.code === 200) {
      ElMessage.success('打分成功')
      gradeDialogVisible.value = false
      await loadSubmissions() // 重新加载提交列表
    } else {
      throw new Error(data.message || '打分失败')
    }
  } catch (error) {
    ElMessage.error(error.message || '打分失败')
  }
}
```

#### 1.5 提交状态显示优化

**提交状态类型和文本显示改进**：
```javascript
// 获取提交状态类型
const getSubmissionStatusType = (submission) => {
  if (submission.status === 'GRADED') return 'success'
  if (!submission.status || submission.status !== 'SUBMITTED') return 'warning'
  if (new Date(submission.submitTime) > new Date(assignment.value?.deadline)) return 'danger'
  return 'success'
}

// 获取提交状态文本
const getSubmissionStatusText = (submission) => {
  if (submission.status === 'GRADED') return '已评分'
  if (!submission.status || submission.status !== 'SUBMITTED') return '未提交'
  if (new Date(submission.submitTime) > new Date(assignment.value?.deadline)) return '逾期提交'
  return '已提交'
}
```

#### 1.6 文件上传大小限制功能

**前端文件大小限制检查**：
```javascript
// 上传前检查
const beforeUploadFile = (file) => {
  // 检查文件大小
  const isLt100M = file.size / 1024 / 1024 < 100;
  if (!isLt100M) {
    ElMessage.error('文件大小不能超过 100MB!');
    return false;
  }
  
  // 检查文件类型
  const allowedTypes = ['.pdf', '.doc', '.docx', '.txt', '.zip', '.rar'];
  const extension = '.' + file.name.split('.').pop().toLowerCase();
  if (!allowedTypes.includes(extension)) {
    ElMessage.error(`只支持以下文件类型: ${allowedTypes.join(', ')}`);
    return false;
  }
  
  return true;
};
```

**文件上传提示**：在前端界面添加了文件大小限制提示，提醒用户单个文件大小不能超过100MB
```html
<template #tip>
  <div class="el-upload__tip">
    文件大小不能超过100MB，选择后自动上传
  </div>
</template>
```

### 2. 后端功能修复

#### 2.1 作业提交API完善
- 修复了作业提交接口，确保文件上传成功后正确保存附件信息
- 优化了提交记录的状态管理

#### 2.2 课程学生信息API优化
- 改进了`getStudentsInCourse`接口，确保能正确返回课程中所有学生的信息
- 修复了学生信息查询时的权限控制问题

#### 2.3 文件存储和访问优化
- 修复了文件上传后的存储路径问题
- 优化了文件访问权限控制，确保只有授权用户能够访问附件

#### 2.4 文件大小限制配置

**后端文件大小限制实现**：
```java
@Override
public String storeFile(MultipartFile file) throws IOException {
    if (file.isEmpty()) {
        throw new IllegalArgumentException("文件为空");
    }

    // 检查文件大小
    if (file.getSize() > maxFileSize) {
        throw new IllegalArgumentException("文件大小超过限制");
    }
    
    // 其他文件处理逻辑...
}
```

**配置文件优化**：在`application.yml`中配置了文件大小限制参数
```yaml
spring:
  servlet:
    multipart:
      max-file-size: 100MB
      max-request-size: 100MB
      file-size-threshold: 2KB
      location: ${user.dir}/temp

file:
  upload:
    base-path: ${FILE_UPLOAD_PATH:./uploads}
    allowed-types: 
    max-size: 104857600  # 100MB
  download:
    base-url: /files
```

## 修复效果

### 1. 统计数据准确性提升
- 总人数现在正确显示课程中的所有学生数量
- 未提交人数准确计算为课程总人数减去已提交人数
- 逾期提交人数计算逻辑保持不变，仍基于提交记录

### 2. 文件上传与下载功能改进
- 文件上传流程更加稳定可靠
- 文件下载功能完全正常，支持多种文件名获取方式
- 下载过程中提供错误处理和用户提示

### 3. 作业详情查看体验优化
- 作业详情展示更加完整，包含所有相关信息
- 附件与提交内容关联正确，下载操作便捷
- 界面布局更加合理，用户体验良好

### 4. 评分系统功能完善
- 评分流程更加顺畅，操作简单直观
- 评语输入功能完整，支持多行文本
- 评分后自动刷新列表，确保数据实时更新

### 5. 教师使用体验整体提升
- 教师可以准确了解班级整体作业完成情况
- 能够清晰识别哪些学生尚未提交作业
- 统计面板数据与实际情况一致
- 作业批改工作流程更加高效

### 6. 文件大小限制功能优化
- 前端增加了文件大小限制检查，防止上传过大文件
- 后端实现了文件大小验证，确保系统安全性
- 统一配置了文件大小限制为100MB，前后端保持一致
- 提供了友好的错误提示，指导用户上传符合要求的文件

## 总结

本次修复对课程资源共享平台的作业管理功能进行了全面优化，涵盖了统计数据准确性、文件上传下载、作业详情查看和评分系统等多个关键模块。通过引入课程学生API获取完整的学生列表、改进文件处理逻辑、优化用户界面和交互体验，使作业管理功能更加实用和可靠。

主要成果包括：
1. 修复了统计数据不准确的核心问题
2. 完善了文件上传和下载功能
3. 优化了作业详情查看体验
4. 改进了评分系统的用户体验
5. 整体提升了教师的工作效率和学生的使用体验

这些修改使作业管理功能更加符合实际教学需求，为教师和学生提供了更加流畅、准确和高效的作业管理体验。